---
title: "example"
format: 
   html:
     code-fold: true
     code-tools: true 
     df-print: paged
---
```{r}
library(tidyverse)
library(here)

source(here("R/read_od_data.R"))
source(here("R/fitting.R"))
```

# Example 1

```{r}
df_comm21 <- read_od_data(
  here("Data/example1.xlsx"),
  blank_wells = well %in% c("F11", "G11", "H11", paste0(LETTERS[1:8], 12))
)

# Adding metadata
df_comm21 <- df_comm21 %>%
  add_metadata(here("Data/example1_metadata.xlsx"))
```

We can plot all of the wells:

```{r}
df_comm21 %>%
  ggplot(aes(x = time_elapsed_min, y = norm_OD, color = plate)) +
  geom_point(size = 0.5) +
  geom_line(aes(color = plate)) +
  facet_grid(row ~ col) +
  theme_bw()
```

We can also plot specific wells based on metadata. Below, we plot wells
containing monocultures:

```{r}
df_comm21 %>%
  filter(type == "Monocultures") %>%
  ggplot(aes(x = time_elapsed_min, y = norm_OD, color = plate)) +
  geom_point(size = 0.5) +
  facet_grid(row ~ col) +
  geom_line(aes(color = plate)) +
  theme_bw()
```

## Fitting

### Exponential

This code fits exponential growth rates for microbial cultures by applying
growthrates::all_easylinear to normalized optical density (norm_OD) measurements
over time. The data is grouped by well and plate, with negative OD values
filtered out. A sliding window (h=5) and smoothing parameter (spar=0.5) are used
to estimate growth parameters for each culture replicate.
```{r}
fit_comm21_exp <- growthrates::all_easylinear(
  norm_OD ~ time_elapsed_min | row + col + plate, 
  data=df_comm21 %>% group_by(well, plate) %>% filter(!any(norm_OD < 0)) %>% ungroup(), 
  h=5, 
  spar=0.5
)
```

The following code gives a table of predictions:
```{r}
df_comm21_exp_pred <- fit_comm21_exp %>% 
  all_pred_exp(norm_OD="y", time_elapsed_min="time") %>%
  filter(norm_OD < max(df_comm21$norm_OD))
```

which we can plot as follows:
```{r}
df_comm21 %>%
  ggplot(aes(x=time_elapsed_min, y=norm_OD, color=plate)) +
  geom_point() + 
  geom_line() +
  geom_line(aes(group=plate), data=df_comm21_exp_pred, color="black", linewidth=1.6) +
  geom_line(data=df_comm21_exp_pred, linetype="dashed", linewidth=1.0) +
  facet_grid(rows=vars(row), cols=vars(col))
```

### Logistic

In a similar manner to fitting exponential, we can fit logistic growth function.
Though, we have to define the upper and lower bounds and initial guesses for the
three parameters in the model.
```{r}
p <- c(y0 = 0.01, mumax = 0.1, K = 1.0)

lower   <- c(y0 = 0.001, mumax = 1e-3, K = 0.5)
upper   <- c(y0 = 0.5,   mumax = 10,    K = 1.5)

fit_comm21_logit <- growthrates::all_growthmodels(
  norm_OD ~ growthrates::grow_logistic(time_elapsed_min, parms) | row + col + plate,
  data=df_comm21,
  p=p,
  lower=lower,
  upper=upper,
)
```

Again, as in the exponential example, we get a dataframe with predicitions given
the logistic growth model:
```{r}
df_comm21_logit_pred <- fit_comm21_logit %>% 
  all_pred_logistic(time_elapsed_min="time", norm_OD="y")
```

which we can plot as follows:
```{r}
df_comm21 %>%
  ggplot(aes(x=time_elapsed_min, y=norm_OD, color=plate)) +
  geom_point() + 
  geom_line() +
  geom_line(aes(group=plate), data=df_comm21_logit_pred, color="black", linewidth=1.6) +
  geom_line(data=df_comm21_logit_pred, linetype="dashed", linewidth=1.0) +
  facet_grid(rows=vars(row), cols=vars(col))
```


which we can plot as follows:
```{r}
df_comm21 %>%
  ggplot(aes(x=time_elapsed_min, y=norm_OD, color=plate)) +
  geom_point() + 
  geom_line() +
  geom_line(aes(group=plate), data=df_comm21_exp_pred, color="black", linewidth=1.6) +
  geom_line(data=df_comm21_exp_pred, linetype="dashed", linewidth=1.0) +
  facet_grid(rows=vars(row), cols=vars(col))
```

# Example 2

Read in P. vulgatus data and B. Uniformis data:

```{r}
df_pvul2 <- read_od_data(
  here("Data/example2.xlsx"),
  sheets = c("Plate 9 - Sheet1", "Plate 7 - Sheet1", "Plate 5 - Sheet1"),
  blank_wells = well %in% c("C10", "D10")
)

df_buni2 <- read_od_data(
  here("Data/example2.xlsx"),
  sheets = c("Plate 8 - Sheet1", "Plate 6 - Sheet1", "Plate 4 - Sheet1"),
  blank_wells = well %in% c("C10", "D10"),
)
```

Then we can plot P. vulgatus:

```{r}
df_pvul2 %>%
  ggplot(aes(x = time_elapsed_min, y = norm_OD, color = plate)) +
  geom_point(size = 0.5) +
  facet_grid(row ~ col, scales = "free") +
  geom_line(aes(color = plate)) +
  theme_bw()
```

and B. uniformis:

```{r}
df_buni2 %>%
  ggplot(aes(x = time_elapsed_min, y = norm_OD, color = plate)) +
  geom_point(size = 0.5) +
  facet_grid(row ~ col, scales = "free") +
  geom_line(aes(color = plate)) +
  theme_bw()
```
# Example 3

We load in another dataset:

```{r}
df_b12 <- read_od_data(
  here("Data/example2.xlsx"),
  sheet = c("Plate 3 - Sheet1", "Plate 2 - Sheet1"),
  blank_wells = col == 12,
  normalize_over = c("time_elapsed_min", "row", "plate")
) %>%
  add_metadata(here("Data/example2_metadata.xlsx"))
```

We can plot it according to the medatdata:

```{r}
df_b12 %>%
  filter(species == "Bunif") %>%
  mutate(brep = as.factor(brep)) %>%
  ggplot(aes(x = time_elapsed_min, y = norm_OD, color = brep)) +
  geom_point(size = 0.5) +
  facet_grid(tech ~ conc) +
  geom_line(aes(color = brep)) +
  theme_bw() +
  scale_y_log10()
```


